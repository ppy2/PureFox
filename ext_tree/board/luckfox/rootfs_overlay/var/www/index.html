<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purefox</title>
    <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
    <div id="central_widget">
        <div id="main_content">
            <table id="renderer_list">
                <tr>
                    <td>
                        <div class="renderer_button" data-service="naa">
                            <button class="button_main">NAA (HQPlayer)</button>
                        </div>
                    </td>
                    <td>
                        <div class="renderer_button" data-service="raat">
                            <button class="button_main">RAAT (Roon)</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="renderer_button" data-service="lms">
                            <button class="button_main">Squeezelite (LMS)</button>
                        </div>
                    </td>
                    <td>
                        <div class="renderer_button" data-service="spotify">
                            <button class="button_main">Spotify Connect</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="renderer_button" data-service="squeeze2upn">
                            <button class="button_main">LMS-UPnP Bridge</button>
                        </div>
                    </td>
                    <td>
                        <div class="renderer_button" data-service="shairport">
                            <button class="button_main">AirPlay</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="renderer_button" data-service="aplayer">
                            <button class="button_main">APlayer (Radio only)</button>
                            <button class="button_secondary">
                                <div class="radio_image">
                                </div>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="renderer_button" data-service="aprenderer">
                            <button class="button_main">APRenderer (UPnP)</button>
                            <button class="button_secondary" id="aprenderer_settings">
                                <div class="settings_image">
                                </div>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="renderer_button" data-service="mpd">
                            <button class="button_main">MPD (UPnP)</button>
                            <button class="button_secondary">
                                <div class="radio_image">
                                </div>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="renderer_button" data-service="apscream">
                            <button class="button_main">APScream (ASIO)</button>
                            <button class="button_secondary">
                                <div class="settings_image">
                                </div>
                            </button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="nopadding_cell">
                        <table cellpadding="0" cellspacing="0">
                            <tr>
                                <td class="full_width_cell right_align_cell">
                                    <span>
                                        Output:
                                    </span>
                                </td>
                                <td>
                                     <div class="output_button" id="output-usb">
                                        <button class="button_main">
                                            USB
                                        </button>
                                    </div>
                                </td>
                                <td>
                                     <div class="output_button" id="output-i2s">
                                        <button class="button_main">
                                            I2S
                                        </button>
                                        <button class="button_secondary">
                                            <div class="settings_image">
                                            </div>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td class="nopadding_cell">
                        <table cellpadding="0" cellspacing="0">
                            <tr>
                                <td class="full_width_cell right_align_cell">
                                    <span>
                                        PureFox v0.3b
                                    </span>
                                </td>
                                <td>
                                    <div id="update_button">
                                        <button class="button_main">
                                            Update
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Всплывающее окно с логом обновления -->
        <div id="update-log-modal">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2a2a2a; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; height: auto; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); color: #ddd; border: 2px solid #555;">
        <h2 style="margin-top: 0; color: #fff; text-align: center;">Обновление прошивки</h2>
            <pre id="update-log-content"></pre>
            <button class="close-modal">Закрыть</button>
        </div>
        </div>

        <div id="purefox_label">
            PureFox
        </div> 

    </div>

    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            function checkActiveService(callback) {
                $.ajax({
                    url: 'check_service.php',
                    method: 'GET',
                    success: function(response) {
                        $('.renderer_button').removeClass('active');
                        if (response) {
                            $(`div[data-service="${response.trim()}"]`).addClass('active');
                        }
                        if (callback) callback(response.trim());
                    }
                });
            }

            function checkAlsaState() {
                $.ajax({
                    url: 'get_alsa_state.php',
                    method: 'GET',
                    success: function(response) {
                        $('.output_button').removeClass('active');
                        switch(response.trim()) {
                            case 'usb':
                                $('#output-usb').addClass('active');
                                break;
                            case 'i2s':
                                $('#output-i2s').addClass('active');
                                break;
                            case 'error':
                                console.error('Ошибка при чтении конфигурации ALSA');
                                break;
                        }
                    },
                    error: function() {
                        console.error('Не удалось получить состояние ALSA');
                    }
                });
            }

            $('.alsa-button').click(function() {
                const cardType = $(this).attr('id').replace('output-', '');
                $.ajax({
                    url: 'handle_alsa.php',
                    method: 'POST',
                    data: { card: cardType },
                    success: function() {
                        checkAlsaState();
                    },
                    error: function() {
                        alert('Ошибка при переключении ALSA');
                    }
                });
            });

            $('.renderer_button').click(function() {
                const service = $(this).data('service');
                const $button = $(this);

                $('.renderer_button').removeClass('active');
                $button.addClass('active');

                $.ajax({
                    url: 'handle_service.php',
                    method: 'POST',
                    data: { service: service },
                    success: function() {
                        let attempts = 0;
                        const MAX_ATTEMPTS = 15;
                        const CHECK_INTERVAL = 1000;

                        const checkInterval = setInterval(() => {
                            checkActiveService((response) => {
                                if (response === service) {
                                    clearInterval(checkInterval);
                                    return;
                                }
                                attempts++;
                                if (attempts >= MAX_ATTEMPTS) {
                                    clearInterval(checkInterval);
                                    $button.removeClass('active');
                                }
                            });
                        }, CHECK_INTERVAL);
                    },
                    error: function() {
                        alert('Ошибка при переключении сервиса');
                        $(this).removeClass('active');
                    }
                });
            });

            checkActiveService();
            checkAlsaState();
            setInterval(checkActiveService, 5000);

            $('#update_button').click(function () {
                if (!confirm("Вы уверены, что хотите обновить прошивку?")) {
                    return;
                }

                $('#update-log-modal').show();
                $('#update-log-content').text("Запуск обновления...\n");

                let logContent = $('#update-log-content');

                $.ajax({
                    url: 'run_update.php',
                    method: 'GET',
                    xhrFields: {
                        onprogress: function (e) {
                            let newText = e.currentTarget.responseText;
                            logContent.append(newText);
                            setTimeout(() => {logContent.scrollTop(logContent.prop("scrollHeight"));}, 100);
                        }
                    },
                    success: function () {
            logContent.html(logContent.html()); // Обновляет содержимое и рендерит HTML
            logContent.append('\n<span class="update-finish">Обновление завершено. Перезагрузите LuckFox</span>');
                    },
                    error: function () {
            logContent.append('\n<span class="update-error">Ошибка при обновлении.</span>');
            logContent.html(logContent.html()); // Обновляет содержимое и рендерит HTML
                    }
                });
            });

            $('.close-modal').click(function () {
                $('#update-log-modal').fadeOut();
            });

            $('#aprenderer_settings').click(function () {
                $.ajax({
                    url: 'get_ip.php',
                    method: 'GET',
                    success: function(response) {
                        const ip = response.trim();
                        const url = `http://${ip}:7779`;
                        window.location.href = url;
                    },
                    error: function() {
                        console.error('Ошибка получения IP-адреса');
                    }
                });
            });
        });
    </script>
        
</body>
</html>