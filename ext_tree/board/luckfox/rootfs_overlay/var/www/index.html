<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio System Control</title>
    <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Audio System Control</h1>

        <!-- Переключатель ALSA -->
        <div class="alsa-toggle">
            <label>ALSA Выход:</label>
            <div class="alsa-buttons">
                <button id="alsa-i2s" class="alsa-button">I2S</button>
                <button id="alsa-usb" class="alsa-button">USB</button>
            </div>
        </div>

        <!-- Кнопки для управления плеерами -->
        <button class="btn-custom primary" data-service="naa" data-process="naa_process">NAA (HQPlayer)</button>
        <button class="btn-custom danger"  data-service="raat" data-process="raat_process">RAAT (Roon)</button>
	<button class="btn-custom success" data-service="mpd" data-process="mpd">UPNP (Mpd)</button>        
	<button class="btn-custom warning" data-service="shairport" data-process="shairport_process">AirPlay</button>
        <button class="btn-custom success" data-service="spotify" data-process="spotify">Spotify Connect</button>
        <button class="btn-custom primary" data-service="lms" data-process="squeezelite">LMS (Squeezelite)</button>
        
<!--    <button class="btn-custom primary" data-service="naa" data-process="naa_process">NAA (HoPlayer)</button>
        <button class="btn-custom success" data-service="raat" data-process="raat_process">RAAT (Roon)</button>
        <button class="btn-custom warning" data-service="upnp-mpd" data-process="mpd">UPNP (MPD)</button>
        <button class="btn-custom danger" data-service="upnp-aplayer" data-process="aplayer">UPNP (APlayer)</button>
        <button class="btn-custom primary" data-service="airplay" data-process="airplay">AirPlay</button>
        <button class="btn-custom success" data-service="lms" data-process="squeezelite">LMS (Squeezelite)</button>
        <button class="btn-custom warning" data-service="shairport" data-process="shairport">ShairportSync</button>
        <button class="btn-custom danger" data-service="screen-audio" data-process="screen_audio">Screen Audio</button>
        <button class="btn-custom primary" data-service="spotify" data-process="spotify">Spotify Connect</button>
        <button class="btn-custom success" data-service="tidal" data-process="tidal">Tidal Connect (Premium account)</button>
        <button class="btn-custom warning" data-service="pure" data-process="pure">Pure</button>
-->                                                                                                            
    </div>

<script src="assets/js/jquery-3.7.1.min.js"></script>
<script>

$(document).ready(function () {
    function checkActiveService(callback) {
        $.ajax({
            url: 'check_service.php',
            method: 'GET',
            success: function(response) {
                $('.btn-custom').removeClass('active');
                if (response) {
                    $(`button[data-service="${response.trim()}"]`).addClass('active');
                }
                if (callback) callback(response.trim());
            }
        });
    }

    function checkAlsaState() {
        $.ajax({
            url: 'get_alsa_state.php',
            method: 'GET',
            success: function(response) {
                $('.alsa-button').removeClass('active');
                
                switch(response.trim()) {
                    case 'usb':
                        $('#alsa-usb').addClass('active');
                        break;
                    case 'i2s':
                        $('#alsa-i2s').addClass('active');
                        break;
                    case 'error':
                        console.error('Ошибка при чтении конфигурации ALSA');
                        break;
                }
            },
            error: function() {
                console.error('Не удалось получить состояние ALSA');
            }
        });
    }

    $('.alsa-button').click(function() {
        const cardType = $(this).attr('id').replace('alsa-', '');
        
        $.ajax({
            url: 'handle_alsa.php',
            method: 'POST',
            data: { card: cardType },
            success: function() {
                checkAlsaState();
            <!-- alert('Успешно переключено на ' + cardType.toUpperCase()); -->
            },
            error: function() {
                alert('Ошибка при переключении ALSA');
            }
        });
    });

    $('.btn-custom').click(function() {
        const service = $(this).data('service');
        const $button = $(this);

        $('.btn-custom').removeClass('active');
        $button.addClass('active');

        $.ajax({
            url: 'handle_service.php',
            method: 'POST',
            data: { service: service },
            success: function() {
                let attempts = 0;
                const MAX_ATTEMPTS = 15; // Увеличиваем количество попыток
                const CHECK_INTERVAL = 1000; // Увеличиваем интервал до 1 секунды

                const checkInterval = setInterval(() => {
                    checkActiveService((response) => {
                        if (response === service) {
                            clearInterval(checkInterval);
                            return;
                        }

                        attempts++;
                        if (attempts >= MAX_ATTEMPTS) {
                            clearInterval(checkInterval);
                            $button.removeClass('active');
                        }
                    });
                }, CHECK_INTERVAL);
            },
            error: function() {
                alert('Ошибка при переключении сервиса');
                $(this).removeClass('active');
            }
        });
    });

    // Первоначальная проверка сервисов и состояния ALSA
    checkActiveService();
    checkAlsaState();

    // Периодическая проверка для сервисов раз в 5 сек
    setInterval(checkActiveService, 5000);
});

</script>
</body>
</html>

