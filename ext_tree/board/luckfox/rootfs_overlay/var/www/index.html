<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio System Control</title>
    <link href="assets/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container">
<!--        <h1>Audio System Control</h1> -->

        <!-- Переключатель ALSA -->
        <div class="alsa-toggle">
            <label>ALSA Выход:</label>
            <div class="alsa-buttons">
                <button id="alsa-i2s" class="alsa-button">I2S</button>
                <button id="alsa-usb" class="alsa-button">USB</button>
            </div>
        </div>

        <!-- Кнопки управления плеерами -->
        <button class="btn-custom primary" data-service="naa" data-process="naa_process">NAA (HQPlayer)</button>
        <button class="btn-custom danger" data-service="raat" data-process="raat_process">RAAT (Roon)</button>
        <button class="btn-custom success" data-service="mpd" data-process="mpd">UPNP (Mpd)</button>        
	<div class="player-buttons" style="display: flex; gap: 10px;">
    	    <button class="btn-custom primary" data-service="aprenderer" data-process="aprenderer">UPNP (APrenderer)</button>
    	    <button class="btn-custom primary" data-service="squeeze2upn" data-process="squeeze2upn">AP-Squeeze</button>
	</div>	    
	<div class="ap-buttons" style="display: flex; gap: 10px;">
	    <button class="btn-custom primary" data-service="aplayer" data-process="aplayer">APlayer</button>
    	    <button class="btn-custom primary" data-service="apscream" data-process="apscream">APscream</button>
        </div>
        <button class="btn-custom warning" data-service="shairport" data-process="shairport_process">AirPlay</button>
        <button class="btn-custom success" data-service="spotify" data-process="spotify">Spotify Connect</button>
        <button class="btn-custom danger" data-service="lms" data-process="squeezelite">LMS (Squeezelite)</button>

        <!-- Кнопка обновления прошивки -->
        PureFox v0.1 beta
        <button id="update-firmware" class="btn-custom warning">Обновить прошивку</button>
    </div>


    <!-- Всплывающее окно с логом обновления -->
    <div id="update-log-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2a2a2a; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; height: auto; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); color: #ddd; border: 2px solid #555;">
	<h2 style="margin-top: 0; color: #fff; text-align: center;">Обновление прошивки</h2>
        <pre id="update-log-content" style="background: #181818; color: #0f0; padding: 10px; text-align: left; height: 300px; overflow-y: auto; white-space: pre-wrap; border: 1px solid #666;"></pre>
        <button class="close-modal" style="display: block; width: 100%; padding: 10px; margin-top: 10px; background: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; text-transform: uppercase;">Закрыть</button>
    </div>
    </div>


    <script src="assets/js/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            function checkActiveService(callback) {
                $.ajax({
                    url: 'check_service.php',
                    method: 'GET',
                    success: function(response) {
                        $('.btn-custom').removeClass('active');
                        if (response) {
                            $(`button[data-service="${response.trim()}"]`).addClass('active');
                        }
                        if (callback) callback(response.trim());
                    }
                });
            }

            function checkAlsaState() {
                $.ajax({
                    url: 'get_alsa_state.php',
                    method: 'GET',
                    success: function(response) {
                        $('.alsa-button').removeClass('active');
                        switch(response.trim()) {
                            case 'usb':
                                $('#alsa-usb').addClass('active');
                                break;
                            case 'i2s':
                                $('#alsa-i2s').addClass('active');
                                break;
                            case 'error':
                                console.error('Ошибка при чтении конфигурации ALSA');
                                break;
                        }
                    },
                    error: function() {
                        console.error('Не удалось получить состояние ALSA');
                    }
                });
            }

            $('.alsa-button').click(function() {
                const cardType = $(this).attr('id').replace('alsa-', '');
                $.ajax({
                    url: 'handle_alsa.php',
                    method: 'POST',
                    data: { card: cardType },
                    success: function() {
                        checkAlsaState();
                    },
                    error: function() {
                        alert('Ошибка при переключении ALSA');
                    }
                });
            });

            $('.btn-custom').click(function() {
                const service = $(this).data('service');
                const $button = $(this);

                $('.btn-custom').removeClass('active');
                $button.addClass('active');

                $.ajax({
                    url: 'handle_service.php',
                    method: 'POST',
                    data: { service: service },
                    success: function() {
                        let attempts = 0;
                        const MAX_ATTEMPTS = 15;
                        const CHECK_INTERVAL = 1000;

                        const checkInterval = setInterval(() => {
                            checkActiveService((response) => {
                                if (response === service) {
                                    clearInterval(checkInterval);
                                    return;
                                }
                                attempts++;
                                if (attempts >= MAX_ATTEMPTS) {
                                    clearInterval(checkInterval);
                                    $button.removeClass('active');
                                }
                            });
                        }, CHECK_INTERVAL);
                    },
                    error: function() {
                        alert('Ошибка при переключении сервиса');
                        $(this).removeClass('active');
                    }
                });
            });

            checkActiveService();
            checkAlsaState();
            setInterval(checkActiveService, 5000);

            $('#update-firmware').click(function () {
                if (!confirm("Вы уверены, что хотите обновить прошивку?")) {
                    return;
                }

                $('#update-log-modal').show();
                $('#update-log-content').text("Запуск обновления...\n");

                let logContent = $('#update-log-content');

                $.ajax({
                    url: 'run_update.php',
                    method: 'GET',
                    xhrFields: {
                        onprogress: function (e) {
                            let newText = e.currentTarget.responseText;
                            logContent.append(newText);
                            setTimeout(() => {logContent.scrollTop(logContent.prop("scrollHeight"));}, 100);
                        }
                    },
                    success: function () {
			logContent.html(logContent.html()); // Обновляет содержимое и рендерит HTML
			logContent.append('\n<span class="update-finish">Обновление завершено. Перезагрузите LuckFox</span>');
                    },
                    error: function () {
			logContent.append('\n<span class="update-error">Ошибка при обновлении.</span>');
			logContent.html(logContent.html()); // Обновляет содержимое и рендерит HTML
                    }
                });
            });

            $('.close-modal').click(function () {
                $('#update-log-modal').fadeOut();
            });
        });
    </script>
</body>
</html>

