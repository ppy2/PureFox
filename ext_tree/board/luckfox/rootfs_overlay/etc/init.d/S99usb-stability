#!/bin/sh

case "$1" in
    start)
        echo "Applying USB stability settings..."
        
        # Disable USB autosuspend for all devices
        for dev in /sys/bus/usb/devices/*/power/control; do
            [ -f "$dev" ] && echo "on" > "$dev" 2>/dev/null || true
        done
        
        # Set longer autosuspend delays
        for dev in /sys/bus/usb/devices/*/power/autosuspend_delay_ms; do  
            [ -f "$dev" ] && echo "10000" > "$dev" 2>/dev/null || true
        done
        
        # Optimize USB core parameters
        echo "-1" > /sys/module/usbcore/parameters/autosuspend 2>/dev/null || true
        echo "1" > /sys/module/usbcore/parameters/use_both_schemes 2>/dev/null || true
        
        # Memory optimizations
        echo "never" > /sys/kernel/mm/transparent_hugepage/enabled 2>/dev/null || true
        echo "0" > /proc/sys/kernel/printk_delay 2>/dev/null || true
        
        # CPU frequency scaling for power stability
        echo "performance" > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor 2>/dev/null || true
        
        # Reduce USB interrupt pressure
        echo "1" > /proc/sys/kernel/timer_migration 2>/dev/null || true
        
        echo "USB stability settings applied."
        ;;
    stop)
        echo "USB stability service stopped."
        ;;  
    restart)
        $0 stop
        $0 start
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
        ;;
esac

exit 0