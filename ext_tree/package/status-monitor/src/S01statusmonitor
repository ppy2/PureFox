#!/bin/sh

DAEMON="status_monitor"
DAEMON_PATH="/opt"
PIDFILE="/tmp/status_monitor.lock"

start() {
    printf "Starting $DAEMON: "
    
    # Check if already running
    if [ -f $PIDFILE ]; then
        PID=$(cat $PIDFILE)
        if kill -0 $PID 2>/dev/null; then
            echo "already running (PID: $PID)"
            return 0
        fi
        rm -f $PIDFILE
    fi
    
    cd $DAEMON_PATH
    start-stop-daemon -S -q -b -m -p $PIDFILE --exec ./$DAEMON
    [ $? = 0 ] && echo "OK" || echo "FAIL"
    renice 15 `pidof status_monitor`
}

stop() {
    printf "Stopping $DAEMON: "
    start-stop-daemon -K -q -p $PIDFILE
    rm -f $PIDFILE
    echo "OK"
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit $?